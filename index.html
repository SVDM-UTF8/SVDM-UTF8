<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Acceso - Sistema Conectado</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            text-align: center;
        }

        /* --- NUEVO: Estilos para la imagen institucional --- */
        .logo {
            text-align: center;
            padding: 15px 0 10px 0;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .logo img {
            max-width: 100px;
            height: auto;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .logo img:hover {
            opacity: 1;
        }

        .header {
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            color: white;
            padding: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 25px;
        }

        .status-card {
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .loading {
            background-color: #fff4e5;
            color: #e67700;
        }

        .authorized {
            background-color: #d5f5e3;
            color: #27ae60;
            border: 2px solid #2ecc71;
        }

        .unauthorized {
            background-color: #fadbd8;
            color: #c0392b;
            border: 2px solid #e74c3c;
        }

        .device-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
        }

        .device-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        button {
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .instructions {
            background-color: #eaf2f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            border-radius: 0 8px 8px 0;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .footer {
            margin-top: 20px;
            color: white;
            text-align: center;
            font-size: 14px;
        }

        .admin-info {
            background-color: #e8f4fc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 13px;
        }

        .admin-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .success-badge {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .warning-badge {
            display: inline-block;
            background-color: #ffc107;
            color: #000;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .danger-badge {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .fingerprint-info {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
            color: #155724;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">
            <img src="images.jpg" alt="Logo Institucional">
        </div>
        <div class="header">
            <h1>Sistema de Verificaci√≥n de Acceso</h1>
            <p>Verificaci√≥n en tiempo real</p>
        </div>

        <div class="content">
            <div id="status" class="status-card loading">
                Verificando dispositivo...
            </div>

            <div class="device-info">
                <h3>Informaci√≥n del Dispositivo</h3>
                <div class="info-row">
                    <span>ID del Dispositivo:</span>
                    <span id="device-id">Calculando...</span>
                </div>
                <div class="info-row">
                    <span>Navegador:</span>
                    <span id="browser">Detectando...</span>
                </div>
                <div class="info-row">
                    <span>Plataforma:</span>
                    <span id="platform">Detectando...</span>
                </div>
                <div class="info-row">
                    <span>Tipo de ID:</span>
                    <span id="id-type">Standard</span>
                </div>
            </div>

            <div class="fingerprint-info">
                <strong>üîí ID Encriptado</strong> - Mayor persistencia y seguridad
            </div>

            <button id="retry-btn">Reintentar Verificaci√≥n</button>
            <button id="reset-btn" style="background: linear-gradient(135deg, #6c757d, #adb5bd);">Resetear ID</button>

            <div class="instructions">
                <h3>Instrucciones:</h3>
                <ol>
                    <li>Este sistema verifica si su dispositivo m√≥vil tiene acceso autorizado</li>
                    <li>El acceso se concede basado en el ID √∫nico de su dispositivo</li>
                    <li>Si no tiene acceso, contacte al administrador para registrar su dispositivo</li>
                </ol>
            </div>

            <div class="admin-info">
                <h3>Estado del Sistema <span class="success-badge" id="connection-status">Conectado</span></h3>
                <p><strong>Modo:</strong> Verificaci√≥n en tiempo real</p>
                <p><strong>Seguridad:</strong> ID Mejorado <span class="success-badge">‚úì</span></p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Sistema de Verificaci√≥n de Acceso de Dispositivos Electr√≥nicos Registrados</p>
    </div>

    <script>
        // URL de tu Google Apps Script (LA MISMA QUE TEN√çAS)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyC2bO6A6Q9EBVXFOLkRlV9eDxTuCIB1GXO1ssZ_RO9xe9Os5AsvURZMnK_RWpfYn0/exec';

        // Versi√≥n MEJORADA pero SIMPLE del generador de IDs
        class SimpleDeviceIdentifier {
            constructor() {
                this.storageKey = 'deviceId_mejorado_v3';
                this.backupKey = 'backupDeviceId';
            }

            // Generar ID de forma simple pero efectiva
            async generateDeviceId() {
                try {
                    // 1. Intentar recuperar ID existente
                    let deviceId = this.getExistingId();

                    if (deviceId) {
                        console.log('ID existente encontrado');
                        document.getElementById('id-type').textContent = 'Existente';
                        return deviceId;
                    }

                    // 2. Generar nuevo ID mejorado
                    console.log('Generando nuevo ID mejorado...');
                    deviceId = await this.createEnhancedId();

                    // 3. Guardar en m√∫ltiples lugares
                    this.saveId(deviceId);

                    document.getElementById('id-type').textContent = 'Nuevo Mejorado';
                    return deviceId;

                } catch (error) {
                    console.error('Error, usando fallback:', error);
                    // Fallback al m√©todo original
                    return this.generateFallbackId();
                }
            }

            // Obtener ID existente
            getExistingId() {
                // Buscar en localStorage primero
                let deviceId = localStorage.getItem(this.storageKey);
                if (deviceId) return deviceId;

                // Buscar en sessionStorage como backup
                deviceId = sessionStorage.getItem(this.backupKey);
                if (deviceId) {
                    // Restaurar en localStorage
                    localStorage.setItem(this.storageKey, deviceId);
                    return deviceId;
                }

                return null;
            }

            // Crear ID mejorado pero simple
            async createEnhancedId() {
                // Informaci√≥n b√°sica pero m√°s estable
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    platform: navigator.platform,
                    screen: `${screen.width}x${screen.height}`,
                    cores: navigator.hardwareConcurrency || 'unknown',
                    memory: navigator.deviceMemory || 'unknown',
                    // A√±adir timestamp para unicidad
                    timestamp: Date.now()
                };

                // Crear hash simple pero √∫nico
                const infoString = JSON.stringify(deviceInfo);
                return await this.simpleHash(infoString);
            }

            // Hash simple y r√°pido
            async simpleHash(data) {
                try {
                    // Usar Web Crypto API si est√° disponible
                    const encoder = new TextEncoder();
                    const dataBuffer = encoder.encode(data);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return 'device_' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
                } catch (error) {
                    // Fallback a m√©todo original
                    return this.originalHash(data);
                }
            }

            // M√©todo original de hash (como backup)
            originalHash(data) {
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return 'device_' + Math.abs(hash).toString(16);
            }

            // Guardar ID en m√∫ltiples lugares
            saveId(deviceId) {
                localStorage.setItem(this.storageKey, deviceId);
                sessionStorage.setItem(this.backupKey, deviceId);
            }

            // Generar ID de fallback (m√©todo original)
            generateFallbackId() {
                document.getElementById('id-type').textContent = 'Fallback';

                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    const userAgent = navigator.userAgent;
                    const language = navigator.language;
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const baseString = `${userAgent}${language}${timezone}`;

                    let hash = 0;
                    for (let i = 0; i < baseString.length; i++) {
                        const char = baseString.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }

                    deviceId = 'device_' + Math.abs(hash).toString(16);
                    localStorage.setItem('deviceId', deviceId);
                }

                return deviceId;
            }

            // Resetear ID
            resetId() {
                localStorage.removeItem(this.storageKey);
                localStorage.removeItem('deviceId');
                sessionStorage.removeItem(this.backupKey);
                console.log('IDs reseteados');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const statusDiv = document.getElementById('status');
            const deviceIdSpan = document.getElementById('device-id');
            const browserSpan = document.getElementById('browser');
            const platformSpan = document.getElementById('platform');
            const retryBtn = document.getElementById('retry-btn');
            const resetBtn = document.getElementById('reset-btn');
            const connectionStatus = document.getElementById('connection-status');

            const deviceIdentifier = new SimpleDeviceIdentifier();

            // Detectar informaci√≥n del navegador y plataforma (R√ÅPIDO)
            browserSpan.textContent = detectBrowser();
            platformSpan.textContent = detectPlatform();

            function detectBrowser() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Otro';
            }

            function detectPlatform() {
                const ua = navigator.userAgent;
                if (ua.includes('Android')) return 'Android';
                if (ua.includes('iPhone') || ua.includes('iPad')) return 'iOS';
                if (ua.includes('Windows')) return 'Windows';
                if (ua.includes('Mac')) return 'Mac';
                if (ua.includes('Linux')) return 'Linux';
                return 'Desconocido';
            }

            // Funci√≥n de verificaci√≥n (EXACTAMENTE IGUAL A LA TUYA)
            async function verifyAccess(deviceId) {
                try {
                    console.log('Verificando dispositivo:', deviceId.substring(0, 20) + '...');

                    const response = await fetch(`${SCRIPT_URL}?deviceId=${encodeURIComponent(deviceId)}`);

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.error) {
                        throw new Error(result.error);
                    }

                    console.log('Respuesta del servidor:', result);
                    return result.authorized;

                } catch (error) {
                    console.error('Error en verifyAccess:', error);
                    connectionStatus.textContent = 'Error de conexi√≥n';
                    connectionStatus.className = 'danger-badge';
                    throw error;
                }
            }

            // Funci√≥n principal de verificaci√≥n
            async function checkAccess() {
                statusDiv.className = 'status-card loading';
                statusDiv.textContent = 'Generando ID seguro...';
                connectionStatus.textContent = 'Conectando...';
                connectionStatus.className = 'warning-badge';

                try {
                    // Generar ID (R√ÅPIDO)
                    const deviceId = await deviceIdentifier.generateDeviceId();
                    deviceIdSpan.textContent = deviceId.length > 24 ? deviceId.substring(0, 24) + '...' : deviceId;

                    // Verificar acceso (CONEXI√ìN ORIGINAL)
                    statusDiv.textContent = 'Conectando con Google Sheets...';
                    const isAuthorized = await verifyAccess(deviceId);

                    // Mostrar resultado
                    if (isAuthorized) {
                        statusDiv.className = 'status-card authorized';
                        statusDiv.textContent = '‚úì ACCESO AUTORIZADO. Bienvenido.';
                        connectionStatus.textContent = 'Conectado';
                        connectionStatus.className = 'success-badge';
                    } else {
                        statusDiv.className = 'status-card unauthorized';
                        statusDiv.textContent = '‚úó ACCESO NO AUTORIZADO. Contacte al administrador.';
                        connectionStatus.textContent = 'Conectado';
                        connectionStatus.className = 'success-badge';
                    }

                } catch (error) {
                    console.error('Error en checkAccess:', error);
                    statusDiv.className = 'status-card unauthorized';

                    if (error.message.includes('configura la URL')) {
                        statusDiv.textContent = 'Error: URL no configurada.';
                    } else if (error.message.includes('Failed to fetch')) {
                        statusDiv.textContent = 'Error de conexi√≥n. Revise su internet.';
                    } else {
                        statusDiv.textContent = 'Error: ' + error.message;
                    }
                }
            }

            // Iniciar verificaci√≥n al cargar
            checkAccess();

            // Bot√≥n reintentar
            retryBtn.addEventListener('click', checkAccess);

            // Bot√≥n reset
            resetBtn.addEventListener('click', function () {
                if (confirm('¬øResetear ID? Se generar√° uno nuevo.')) {
                    deviceIdentifier.resetId();
                    statusDiv.className = 'status-card loading';
                    statusDiv.textContent = 'ID reseteado. Regenerando...';
                    setTimeout(checkAccess, 500);
                }
            });
        });
    </script>
</body>

</html>